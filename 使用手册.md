# Dify工作流导出器使用手册

## 概述

本工作流导出器支持三种数据源模式，可以从不同的来源获取Dify工作流数据：

1. **数据库连接模式**：直接连接Dify的PostgreSQL数据库
2. **API调用模式**：通过Dify的API接口获取数据
3. **手动导入模式**：手动上传工作流数据文件

## 配置详解

### 1. 数据库连接模式

#### 适用场景
- 您有Dify数据库的直接访问权限
- 需要获取最完整和最新的工作流数据
- 对性能要求较高

#### 配置步骤

1. **获取Dify数据库连接信息**
   - 主机地址（通常是localhost或IP地址）
   - 端口号（PostgreSQL默认5432）
   - 数据库名称（通常是dify）
   - 用户名和密码

2. **配置config.yaml**
   ```yaml
   data_source: 'database'
   database:
     type: 'postgresql'
     host: 'localhost'          # 数据库主机
     port: 5432                # 数据库端口
     database: 'dify'          # 数据库名称
     username: 'postgres'      # 数据库用户名
     password: 'your_password' # 数据库密码
     
     # 可选：连接池配置
     pool_size: 10
     max_overflow: 20
     pool_timeout: 30
     
     # 可选：SSL配置
     ssl_mode: 'prefer'
   ```

3. **安装依赖**
   ```bash
   pip install psycopg2-binary
   ```

4. **测试连接**
   启动应用后，系统会自动测试数据库连接。

#### 注意事项
- 确保防火墙允许数据库连接
- 数据库用户需要有读取权限
- 如果Dify使用了自定义表名，需要在配置中指定

### 2. API调用模式

#### 适用场景
- 无法直接访问Dify数据库
- 需要通过API获取数据
- 数据安全性要求较高

#### 配置步骤

1. **获取Dify API信息**
   - API基础URL
   - 认证Token或API Key

2. **配置config.yaml**
   ```yaml
   data_source: 'api'
   api:
     base_url: 'http://localhost:5001'  # Dify API地址
     
     # Bearer Token认证
     auth:
       type: 'bearer'
       token: 'your_api_token_here'
     
     # 或者API Key认证
     # auth:
     #   type: 'api_key'
     #   api_key: 'your_api_key'
     #   api_key_header: 'X-API-Key'
     
     # 可选：API端点配置
     endpoints:
       apps: '/api/apps/{app_id}'
       workflows: '/api/apps/{app_id}/workflows/draft'
       environment_variables: '/api/apps/{app_id}/env-variables'
     
     # 可选：请求配置
     timeout: 30
     retry_count: 3
   ```

3. **测试API连接**
   启动应用后，系统会自动测试API连接。

#### 注意事项
- 确保API URL正确且可访问
- 检查认证信息是否有效
- 注意API调用频率限制

### 3. 手动导入模式

#### 适用场景
- 无法直接访问Dify系统
- 需要离线处理工作流数据
- 用于测试或演示目的

#### 配置步骤

1. **配置config.yaml**
   ```yaml
   data_source: 'manual'
   manual:
     storage_type: 'file'
     file_storage:
       data_dir: './data'              # 数据存储目录
       supported_formats: ['json', 'yaml', 'yml']
       auto_backup: true               # 自动备份
       backup_dir: './data/backups'    # 备份目录
   ```

2. **准备工作流数据文件**
   创建符合格式的工作流数据文件，例如：

   ```yaml
   # data/your-app-id.yaml
   version: '1.0'
   kind: app
   app:
     name: 您的工作流应用
     mode: workflow
     icon: 🚀
     description: 应用描述
   workflow:
     version: '1.0'
     graph:
       nodes:
         - id: start
           type: start
           data:
             type: start
             title: 开始
       edges: []
     features: {}
     environment_variables:
       - name: API_KEY
         value: your_api_key
         value_type: secret
   ```

3. **导入数据**
   将准备好的文件放入配置的数据目录中。

#### 数据文件格式要求
- 支持JSON和YAML格式
- 文件名格式：`{app_id}.{format}`
- 必须包含`app`和`workflow`两个顶级字段

## 环境变量配置

您可以使用环境变量覆盖配置文件中的设置：

```bash
# 数据库配置
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=dify
export DB_USER=postgres
export DB_PASSWORD=your_password

# API配置
export DIFY_API_URL=http://localhost:5001
export DIFY_API_TOKEN=your_api_token

# 其他配置
export LOG_LEVEL=DEBUG
```

## 使用方法

### 1. 启动系统

```bash
# 使用启动脚本
./start.sh

# 或手动启动
cd backend
python app.py
```

### 2. 访问Web界面

打开浏览器访问：`http://localhost:3000`

### 3. 导出工作流

1. 在输入框中输入应用ID
2. 点击"获取工作流"按钮
3. 查看工作流信息
4. 点击"导出DSL"按钮

### 4. 处理敏感信息

如果工作流包含敏感信息（如API密钥），系统会弹出确认对话框：
- 选择是否包含敏感信息
- 查看将要导出的敏感变量列表
- 确认后完成导出

## 故障排除

### 数据库连接问题

1. **连接被拒绝**
   - 检查数据库是否启动
   - 确认主机和端口配置正确
   - 检查防火墙设置

2. **认证失败**
   - 确认用户名和密码正确
   - 检查用户是否有访问权限

3. **表不存在**
   - 确认表名配置正确
   - 检查数据库schema

### API连接问题

1. **网络连接失败**
   - 检查API URL是否正确
   - 确认网络连接正常

2. **认证失败**
   - 检查Token或API Key是否有效
   - 确认认证方式配置正确

3. **API端点不存在**
   - 检查端点配置是否正确
   - 确认API版本兼容性

### 手动导入问题

1. **文件格式错误**
   - 检查文件是否符合格式要求
   - 使用YAML或JSON验证工具检查语法

2. **数据字段缺失**
   - 确认必需字段存在
   - 检查数据结构是否正确

## 高级配置

### 缓存配置

```yaml
cache:
  enabled: true
  type: 'memory'    # memory, redis, file
  ttl: 300          # 缓存时间（秒）
```

### 日志配置

```yaml
logging:
  level: 'INFO'     # DEBUG, INFO, WARNING, ERROR
  file: 'logs/app.log'
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
```

### 安全配置

```yaml
security:
  allowed_ips: []   # 允许的IP地址（空表示允许所有）
  rate_limit:
    enabled: true
    requests_per_minute: 60
```

## 最佳实践

1. **数据备份**
   - 定期备份配置文件
   - 手动导入模式下启用自动备份

2. **安全考虑**
   - 不要在配置文件中直接写入敏感信息
   - 使用环境变量存储密码和Token
   - 定期更换API密钥

3. **性能优化**
   - 启用缓存减少重复请求
   - 合理设置连接池大小
   - 监控日志文件大小

4. **故障预防**
   - 定期测试数据库连接
   - 监控API调用频率
   - 保持配置文件简洁明了

## 联系支持

如果您在使用过程中遇到问题，请：

1. 查看日志文件获取详细错误信息
2. 检查配置文件格式和内容
3. 确认网络连接和权限设置
4. 联系技术支持团队 